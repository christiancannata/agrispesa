jQuery(document).ready(function(e){const o=window.pagenow.length?window.pagenow:"";if(window.typenow.length&&window.typenow,"edit-product"===o){let _=!1;e("input#doaction, input#doaction2").on("click",function(o){if(_)return!0;o.preventDefault();let t=e(this),n=t.prev("select").val();if("facebook_include"===n){let o=[];e.each(e('input[name="post[]"]:checked'),function(){o.push(parseInt(e(this).val(),10))}),e.post(facebook_for_woocommerce_products_admin.ajax_url,{action:"facebook_for_woocommerce_set_product_sync_bulk_action_prompt",security:facebook_for_woocommerce_products_admin.set_product_sync_bulk_action_prompt_nonce,toggle:n,products:o},function(o){o&&!o.success?(closeExistingModal(),new e.WCBackboneModal.View({target:"facebook-for-woocommerce-modal",string:o.data})):(_=!0,t.trigger("click"))})}else _=!0,t.trigger("click")})}if("product"===o){function t(e,o){o.find(".enable-if-sync-enabled").prop("disabled",!e),o.find("select").not(".enable-if-sync-enabled").prop("disabled",!e)}function n(e,o){e?(o.find("option[value='sync_and_show']").show(),o.prop("original")&&o.val(o.prop("original"))):(o.find("option[value='sync_and_show']").hide(),"sync_and_show"===o.val()&&o.val("sync_and_hide"))}function i(e,o){let t=o.find("#wc_facebook_commerce_enabled"),n=t.prop("original");t.prop("checked",!!e&&n).prop("disabled",!e),t.trigger("change"),t.prop("original",n),o.find("#product-not-ready-notice, #variable-product-not-ready-notice").hide(),s()&&!c()?o.find("#variable-product-not-ready-notice").show():e||o.find("#product-not-ready-notice").show()}function a(){return!!(s()?c():"sync_disabled"!==b.val())&&!!(s()||e("#_regular_price").val()||e("#fb_product_price").val())&&!(!e("#_manage_stock").prop("checked")||!e("#_stock").val())}function c(){let o=e(".js-variable-fb-sync-toggle");return 0===o.length?!!facebook_for_woocommerce_products_admin.is_sync_enabled_for_product:!!o.map((o,t)=>"sync_disabled"!==e(t).val()?t:null).length}function s(){var o=e("select#product-type").val();return!(!o||!o.match(/variable/))}function r(e){e.attr("data-original-value",e.val())}function l(o){return b===o?e("input#post_ID").val():o.closest(".woocommerce_variation").find("input[name^=variable_post_id]").val()}function d(o){h=h.filter(function(e){return e!==o}),e(facebook_for_woocommerce_products_admin.product_removed_from_sync_field_id).val(h.join(","))}let h=[];e("#facebook_options #wc_facebook_commerce_enabled").on("change",function(){let o=e(this).prop("checked");o?e(".wc_facebook_commerce_fields").show():e(".wc_facebook_commerce_fields").hide(),e(".product_attributes").find(".woocommerce_attribute").length?e(".show_if_has_attributes").show():e(".show_if_has_attributes").hide(),e(this).prop("original",o)}).trigger("change");const b=e("#wc_facebook_sync_mode"),g=b.closest(".woocommerce_options_panel");r(b),b.on("change",function(){let e="sync_disabled"!==b.val();t(e,g),e&&d(l(b)),b.prop("original",b.val())}).trigger("change"),e("#_virtual").on("change",function(){n(!e(this).prop("checked"),b)}).trigger("change"),e("input[name=_visibility]").on("change",function(){"hidden"!==e(this).val()&&"search"!==e(this).val()&&"sync_disabled"===b.val()&&b.val("sync_and_show").trigger("change")});const v=e("#woocommerce-product-data");function f(){e(".js-fb-product-image-source:checked").each(function(){e(this).trigger("change")})}v.on("change","#_regular_price, #_manage_stock, #_stock, #wc_facebook_sync_mode, #fb_product_price",function(o){setTimeout(function(){i(a(),e("#facebook_options"))},1)}),e(".woocommerce_variations").on("change",".js-variable-fb-sync-toggle",function(){let o=e(this),n="sync_disabled"!==o.val();t(n,o.closest(".wc-metabox-content")),i(a(),e("#facebook_options")),n&&d(l(o)),o.prop("original",o.val())}),v.on("woocommerce_variations_loaded",function(){v.find(".js-variable-fb-sync-toggle").each(function(o,n){let i=e(n);t("sync_disabled"!==i.val(),i.closest(".wc-metabox-content")),i.prop("original",i.val()),r(i)}),e(".variable_is_virtual").on("change",function(){const o=e(this).closest(".wc-metabox-content").find(".js-variable-fb-sync-toggle");n(!e(this).prop("checked"),o)}),i(a(),e("#facebook_options"))}),v.on("change",".js-fb-product-image-source",function(){let o=e(this).closest(".woocommerce_options_panel, .wc-metabox-content"),t=e(this).val();if(o.find(".product-image-source-field").closest(".form-field").hide(),o.find(`.show-if-product-image-source-${t}`).closest(".form-field").show(),o.hasClass("wc-metabox-content")){o.find(".product-image-source-field").removeClass("show"),o.find(`.show-if-product-image-source-${t}`).addClass("show");let e=o.find(".fb-product-images-thumbnails");"multiple"===t?e.show():e.hide()}}),e(document).ready(function(){if(0===e(".js-fb-product-image-source").length){const o=new MutationObserver(function(t){t.forEach(function(t){t.addedNodes.length>0&&e(t.addedNodes).find(".js-fb-product-image-source").length>0&&(f(),o.disconnect())})});o.observe(document.body,{childList:!0,subtree:!0})}else f()}),v.on("woocommerce_variations_loaded",function(){e(".js-variable-fb-sync-toggle:visible").trigger("change"),f(),e(".variable_is_virtual:visible").trigger("change")}),e("#facebook_options").on("click","#product-not-ready-notice-open-modal",function(o){o.preventDefault(),closeExistingModal(),new e.WCBackboneModal.View({target:"facebook-for-woocommerce-modal",string:{message:facebook_for_woocommerce_products_admin.product_not_ready_modal_message,buttons:facebook_for_woocommerce_products_admin.product_not_ready_modal_buttons}})}),i(a(),g);const w=e("#open_media_library"),k=e("#fb_product_video_selected_thumbnails"),y=e("#fb_product_video");let x,j=y.val()?y.val().split(",").map(Number):[];function u(){y.val(j.join(","))}function m(e,o){j=j.filter(o=>o!==e),u(),o.remove()}w.on("click",function(o){o.preventDefault(),x||(x=wp.media({title:"Select videos",button:{text:"Save"},library:{type:"video"},multiple:!0}),x.on("open",function(){x.$el.addClass("fb-product-video-media-frame");const e=x.state().get("selection");j.forEach(function(o){const t=wp.media.attachment(o);t.fetch(),e.add(t?[t]:[])})}),x.on("select",function(){!function(o){const t=o.map(e=>e.id),n=j.filter(e=>!t.includes(e)),i=t.filter(e=>!j.includes(e));k.find(".form-field").each(function(){const o=e(this),t=parseInt(o.find("span").data("attachment-id"),10);n.includes(t)&&m(t,o)}),o.each(function(o){if(o=o.toJSON(),i.includes(o.id)&&o.mime&&o.mime.startsWith("video/")){const t=function(o){const t=e("<p>",{class:"form-field video-thumbnail"}),n=e("<img>",{src:o.icon}),i=e("<span>",{text:o.url,"data-attachment-id":o.id}),a=e("<a>",{href:"#",text:"Remove",class:"remove-video"});return a.on("click",function(e){e.preventDefault(),m(o.id,t)}),t.append(n,i,a),t}(o);k.append(t),j.push(o.id)}else o.mime.startsWith("video/")||alert("Please select a valid video file.")}),u()}(x.state().get("selection"))})),x.open()}),k.on("click",".remove-video",function(o){o.preventDefault();const t=e(this);m(t.data("attachment-id"),t.closest(".form-field"))});let D={};function p(o,t,n){const i=e(`#variable_fb_product_images${t}`);if(!i.length)return;let a=i.val()?i.val().split(",").map(Number):[];a=a.filter(e=>e!==o),i.val(a.join(",")),n.remove()}e(document).on("click",".fb-open-images-library",function(o){o.preventDefault();const t=e(this),n=t.data("variation-index");t.data("variation-id"),D[n]||(D[n]=wp.media({title:"Select Images for Variation",button:{text:"Use Images"},library:{type:"image"},multiple:!0}),D[n].on("open",function(){D[n].$el.addClass("fb-product-images-media-frame");const o=D[n].state().get("selection"),t=e(`#variable_fb_product_images${n}`);t.length?(t.val()?t.val().split(",").map(Number):[]).forEach(function(e){const t=wp.media.attachment(e);t.fetch(),o.add(t?[t]:[])}):console.warn("Hidden field not found for variation:",n)}),D[n].on("select",function(){!function(o,t){const n=e(`#fb_product_images_selected_thumbnails_${t}`),i=e(`#variable_fb_product_images${t}`);if(!i.length)return;let a=i.val()?i.val().split(",").map(Number):[];const c=o.map(e=>e.id),s=a.filter(e=>!c.includes(e)),r=c.filter(e=>!a.includes(e));n.find(".form-field").each(function(){const o=e(this),n=parseInt(o.find("span").data("attachment-id"),10);s.includes(n)&&p(n,t,o)}),o.each(function(o){if(o=o.toJSON(),r.includes(o.id)&&o.mime&&o.mime.startsWith("image/")){const i=function(o,t){const n=e("<p>",{class:"form-field image-thumbnail"}),i=e("<img>",{src:o.sizes&&o.sizes.thumbnail?o.sizes.thumbnail.url:o.url}),a=e("<span>",{text:o.filename||o.title,"data-attachment-id":o.id}),c=e("<a>",{href:"#",text:"Remove",class:"remove-image","data-variation-index":t,"data-attachment-id":o.id});return c.on("click",function(e){e.preventDefault(),p(o.id,t,n)}),n.append(i,a,c),n}(o,t);n.append(i),a.includes(o.id)||a.push(o.id)}else!r.includes(o.id)||o.mime&&o.mime.startsWith("image/")||alert("Please select a valid image file.")}),i.val(a.join(","))}(D[n].state().get("selection"),n)})),D[n].open()}),e(document).on("click",".fb-product-images-thumbnails .remove-image",function(o){o.preventDefault();const t=e(this),n=parseInt(t.data("attachment-id"),10),i=t.closest(".fb-product-images-thumbnails").attr("id");p(n,i?parseInt(i.split("_").pop(),10):0,t.closest(".image-thumbnail"))})}});