jQuery(document).ready(function(e){const t=window.pagenow.length?window.pagenow:"";if(window.typenow.length&&window.typenow,"edit-product"===t){let v=!1;e("input#doaction, input#doaction2").on("click",function(t){if(v)return!0;t.preventDefault();let o=e(this),i=o.prev("select").val();if("facebook_include"===i){let t=[];e.each(e('input[name="post[]"]:checked'),function(){t.push(parseInt(e(this).val(),10))}),e.post(facebook_for_woocommerce_products_admin.ajax_url,{action:"facebook_for_woocommerce_set_product_sync_bulk_action_prompt",security:facebook_for_woocommerce_products_admin.set_product_sync_bulk_action_prompt_nonce,toggle:i,products:t},function(t){t&&!t.success?(closeExistingModal(),new e.WCBackboneModal.View({target:"facebook-for-woocommerce-modal",string:t.data})):(v=!0,o.trigger("click"))})}else v=!0,o.trigger("click")})}if("product"===t){function o(e,t){t.find(".enable-if-sync-enabled").prop("disabled",!e),t.find("select").not(".enable-if-sync-enabled").prop("disabled",!e)}function i(e,t){e?(t.find("option[value='sync_and_show']").show(),t.prop("original")&&t.val(t.prop("original"))):(t.find("option[value='sync_and_show']").hide(),"sync_and_show"===t.val()&&t.val("sync_and_hide"))}function n(e,t){let o=t.find("#wc_facebook_commerce_enabled"),i=o.prop("original");o.prop("checked",!!e&&i).prop("disabled",!e),o.trigger("change"),o.prop("original",i),t.find("#product-not-ready-notice, #variable-product-not-ready-notice").hide(),s()&&!c()?t.find("#variable-product-not-ready-notice").show():e||t.find("#product-not-ready-notice").show()}function a(){return!!(s()?c():"sync_disabled"!==w.val())&&!!(s()||e("#_regular_price").val()||e("#fb_product_price").val())&&!(!e("#_manage_stock").prop("checked")||!e("#_stock").val())}function c(){let t=e(".js-variable-fb-sync-toggle");return 0===t.length?!!facebook_for_woocommerce_products_admin.is_sync_enabled_for_product:!!t.map((t,o)=>"sync_disabled"!==e(o).val()?o:null).length}function s(){var t=e("select#product-type").val();return!(!t||!t.match(/variable/))}function d(e){e.attr("data-original-value",e.val())}function r(t){return w===t?e("input#post_ID").val():t.closest(".woocommerce_variation").find("input[name^=variable_post_id]").val()}function l(t){g=g.filter(function(e){return e!==t}),e(facebook_for_woocommerce_products_admin.product_removed_from_sync_field_id).val(g.join(","))}let g=[];e("#facebook_options #wc_facebook_commerce_enabled").on("change",function(){let t=e(this).prop("checked");t?e(".wc_facebook_commerce_fields").show():e(".wc_facebook_commerce_fields").hide(),e(".product_attributes").find(".woocommerce_attribute").length?e(".show_if_has_attributes").show():e(".show_if_has_attributes").hide(),e(this).prop("original",t)}).trigger("change");const w=e("#wc_facebook_sync_mode"),k=w.closest(".woocommerce_options_panel");d(w),w.on("change",function(){let e="sync_disabled"!==w.val();o(e,k),e&&l(r(w)),w.prop("original",w.val())}).trigger("change"),e("#_virtual").on("change",function(){i(!e(this).prop("checked"),w)}).trigger("change"),e("input[name=_visibility]").on("change",function(){"hidden"!==e(this).val()&&"search"!==e(this).val()&&"sync_disabled"===w.val()&&w.val("sync_and_show").trigger("change")});const y=e("#woocommerce-product-data");function f(){e("#facebook_options .fb-product-video-source-field .wc-radios li:first-child label, .woocommerce_variation .fb-product-video-source-field .wc-radios li:first-child label").each(function(){let t=e(this),o=t.closest(".fb-product-video-source-field").next("p.product-video-source-field").find("button");o.length&&!t.find("button").length&&t.append(" ").append(o)})}function u(){e(".js-fb-product-image-source:checked").each(function(){e(this).trigger("change")})}function p(){e(".js-fb-product-video-source:checked").each(function(){e(this).trigger("change")})}y.on("change","#_regular_price, #_manage_stock, #_stock, #wc_facebook_sync_mode, #fb_product_price",function(t){setTimeout(function(){n(a(),e("#facebook_options"))},1)}),e(".woocommerce_variations").on("change",".js-variable-fb-sync-toggle",function(){let t=e(this),i="sync_disabled"!==t.val();o(i,t.closest(".wc-metabox-content")),n(a(),e("#facebook_options")),i&&l(r(t)),t.prop("original",t.val())}),y.on("woocommerce_variations_loaded",function(){y.find(".js-variable-fb-sync-toggle").each(function(t,i){let n=e(i);o("sync_disabled"!==n.val(),n.closest(".wc-metabox-content")),n.prop("original",n.val()),d(n)}),e(".variable_is_virtual").on("change",function(){const t=e(this).closest(".wc-metabox-content").find(".js-variable-fb-sync-toggle");i(!e(this).prop("checked"),t)}),n(a(),e("#facebook_options"))}),y.on("change",".js-fb-product-image-source",function(){let t=e(this).closest(".woocommerce_options_panel, .wc-metabox-content"),o=e(this).val();if(t.find(".product-image-source-field").closest(".form-field").hide(),t.find(`.show-if-product-image-source-${o}`).closest(".form-field").show(),t.hasClass("wc-metabox-content")){t.find(".product-image-source-field").removeClass("show"),t.find(`.show-if-product-image-source-${o}`).addClass("show");let e=t.find(".fb-product-images-thumbnails");"multiple"===o?e.show():e.hide()}}),y.on("change",".js-fb-product-video-source",function(){let t=e(this).closest(".woocommerce_options_panel, .wc-metabox-content"),o=e(this).val();t.find(".product-video-source-field").removeClass("show").closest(".form-field").hide(),t.find(`.show-if-product-video-source-${o}`).addClass("show").closest(".form-field").show()}),e(document).ready(function(){if(0===e(".js-fb-product-image-source").length){const t=new MutationObserver(function(o){o.forEach(function(o){o.addedNodes.length>0&&e(o.addedNodes).find(".js-fb-product-image-source").length>0&&(u(),t.disconnect())})});t.observe(document.body,{childList:!0,subtree:!0})}else u()}),e(document).ready(function(){if(0===e(".js-fb-product-video-source").length){const t=new MutationObserver(function(o){o.forEach(function(o){o.addedNodes.length>0&&e(o.addedNodes).find(".js-fb-product-video-source").length>0&&(f(),p(),t.disconnect())})});t.observe(document.body,{childList:!0,subtree:!0})}else f(),p()}),y.on("woocommerce_variations_loaded",function(){e(".js-variable-fb-sync-toggle:visible").trigger("change"),u(),f(),p(),e(".variable_is_virtual:visible").trigger("change")}),e("#facebook_options").on("click","#product-not-ready-notice-open-modal",function(t){t.preventDefault(),closeExistingModal(),new e.WCBackboneModal.View({target:"facebook-for-woocommerce-modal",string:{message:facebook_for_woocommerce_products_admin.product_not_ready_modal_message,buttons:facebook_for_woocommerce_products_admin.product_not_ready_modal_buttons}})}),n(a(),k),e("form#post").on("submit",function(){e("#facebook_options .enable-if-sync-enabled").prop("disabled",!1),e("#facebook_options select").prop("disabled",!1),e(".woocommerce_variations .enable-if-sync-enabled").prop("disabled",!1),e(".woocommerce_variations select").prop("disabled",!1)});const x=e("#open_media_library"),j=e("#fb_product_video_selected_thumbnails"),N=e("#fb_product_video");let $,D=N.val()?N.val().split(",").map(Number):[];function m(){N.val(D.join(","))}function _(e,t){D=D.filter(t=>t!==e),m(),t.remove()}x.on("click",function(t){t.preventDefault(),$||($=wp.media({title:"Select videos",button:{text:"Save"},library:{type:"video"},multiple:!0}),$.on("open",function(){$.$el.addClass("fb-product-video-media-frame");const e=$.state().get("selection");D.forEach(function(t){const o=wp.media.attachment(t);o.fetch(),e.add(o?[o]:[])})}),$.on("select",function(){!function(t){const o=t.map(e=>e.id),i=D.filter(e=>!o.includes(e)),n=o.filter(e=>!D.includes(e));j.find(".form-field").each(function(){const t=e(this),o=parseInt(t.find("span").data("attachment-id"),10);i.includes(o)&&_(o,t)}),t.each(function(t){if(t=t.toJSON(),n.includes(t.id)&&t.mime&&t.mime.startsWith("video/")){const o=function(t){const o=e("<p>",{class:"form-field video-thumbnail"}),i=e("<img>",{src:t.icon}),n=e("<span>",{text:t.url,"data-attachment-id":t.id}),a=e("<a>",{href:"#",text:"Remove",class:"remove-video"});return a.on("click",function(e){e.preventDefault(),_(t.id,o)}),o.append(i,n,a),o}(t);j.append(o),D.push(t.id)}else t.mime.startsWith("video/")||alert("Please select a valid video file.")}),m()}($.state().get("selection"))})),$.open()}),j.on("click",".remove-video",function(t){t.preventDefault();const o=e(this);_(o.data("attachment-id"),o.closest(".form-field"))});let I={};function h(t,o,i){const n=e(`#variable_fb_product_images${o}`);if(!n.length)return;let a=n.val()?n.val().split(",").map(Number):[];a=a.filter(e=>e!==t),n.val(a.join(",")),i.remove()}e(document).on("click",".fb-open-images-library",function(t){t.preventDefault();const o=e(this),i=o.data("variation-index");o.data("variation-id"),I[i]||(I[i]=wp.media({title:"Select Images for Variation",button:{text:"Use Images"},library:{type:"image"},multiple:!0}),I[i].on("open",function(){I[i].$el.addClass("fb-product-images-media-frame");const t=I[i].state().get("selection"),o=e(`#variable_fb_product_images${i}`);o.length&&(o.val()?o.val().split(",").map(Number):[]).forEach(function(e){const o=wp.media.attachment(e);o.fetch(),t.add(o?[o]:[])})}),I[i].on("select",function(){!function(t,o){const i=e(`#fb_product_images_selected_thumbnails_${o}`),n=e(`#variable_fb_product_images${o}`);if(!n.length)return;let a=n.val()?n.val().split(",").map(Number):[];const c=t.map(e=>e.id),s=a.filter(e=>!c.includes(e)),d=c.filter(e=>!a.includes(e));i.find(".form-field").each(function(){const t=e(this),i=parseInt(t.find("span").data("attachment-id"),10);s.includes(i)&&h(i,o,t)}),t.each(function(t){if(t=t.toJSON(),d.includes(t.id)&&t.mime&&t.mime.startsWith("image/")){const n=function(t,o){const i=e("<p>",{class:"form-field image-thumbnail"}),n=e("<img>",{src:t.sizes&&t.sizes.thumbnail?t.sizes.thumbnail.url:t.url}),a=e("<span>",{text:t.filename||t.title,"data-attachment-id":t.id}),c=e("<a>",{href:"#",text:"Remove",class:"remove-image","data-variation-index":o,"data-attachment-id":t.id});return c.on("click",function(e){e.preventDefault(),h(t.id,o,i)}),i.append(n,a,c),i}(t,o);i.append(n),a.includes(t.id)||a.push(t.id)}else!d.includes(t.id)||t.mime&&t.mime.startsWith("image/")||alert("Please select a valid image file.")}),n.val(a.join(","))}(I[i].state().get("selection"),i)})),I[i].open()}),e(document).on("click",".fb-product-images-thumbnails .remove-image",function(t){t.preventDefault();const o=e(this),i=parseInt(o.data("attachment-id"),10),n=o.closest(".fb-product-images-thumbnails").attr("id");h(i,n?parseInt(n.split("_").pop(),10):0,o.closest(".image-thumbnail"))});let C={};function b(t,o,i){const n=e(`#variable_fb_product_video${o}`);if(!n.length)return;let a=n.val()?n.val().split(",").map(Number):[];a=a.filter(e=>e!==t),n.val(a.join(",")),i.remove()}e(document).on("click",".fb-open-video-library",function(t){t.preventDefault();const o=e(this),i=o.data("variation-index");o.data("variation-id"),C[i]||(C[i]=wp.media({title:"Select Video for Variation",button:{text:"Use Video"},library:{type:"video"},multiple:!0}),C[i].on("open",function(){C[i].$el.addClass("fb-product-video-media-frame");const t=C[i].state().get("selection"),o=e(`#variable_fb_product_video${i}`);o.length&&(o.val()?o.val().split(",").map(Number):[]).forEach(function(e){const o=wp.media.attachment(e);o.fetch(),t.add(o?[o]:[])})}),C[i].on("select",function(){!function(t,o){const i=e(`#fb_product_video_selected_thumbnails_${o}`),n=e(`#variable_fb_product_video${o}`);if(!n.length)return;let a=n.val()?n.val().split(",").map(Number):[];const c=t.map(e=>e.id),s=a.filter(e=>!c.includes(e)),d=c.filter(e=>!a.includes(e));i.find(".form-field").each(function(){const t=e(this),i=parseInt(t.find("span").data("attachment-id"),10);s.includes(i)&&b(i,o,t)}),t.each(function(t){t=t.toJSON();const n=d.includes(t.id),c=t.mime&&t.mime.startsWith("video/");if(n&&c){const n=function(t,o){const i=e("<p>",{class:"form-field video-thumbnail"}),n=e("<img>",{src:t.icon}),a=e("<span>",{text:t.url,"data-attachment-id":t.id}),c=e("<a>",{href:"#",text:"Remove",class:"remove-video","data-variation-index":o,"data-attachment-id":t.id});return c.on("click",function(e){e.preventDefault(),b(t.id,o,i)}),i.append(n,a,c),i}(t,o);i.append(n),a.includes(t.id)||a.push(t.id)}else n&&!c&&alert("Please select a valid video file.")}),n.val(a.join(","))}(C[i].state().get("selection"),i)})),C[i].open()}),e(document).on("click",".fb-product-video-thumbnails .remove-video",function(t){t.preventDefault();const o=e(this);b(parseInt(o.data("attachment-id"),10),parseInt(o.data("variation-index"),10),o.closest(".video-thumbnail"))})}});